name: CI/CD
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      IMAGE_REPO: polaris-secuone-dashboard
    outputs:
      image_latest: ${{ steps.vars.outputs.image_latest }}
      image_sha:    ${{ steps.vars.outputs.image_sha }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # 빌드툴 자동 감지
      - name: Detect build tool
        id: detect
        run: |
          if [ -f "mvnw" ] || [ -f "pom.xml" ]; then
            echo "tool=maven" >> $GITHUB_OUTPUT
          elif [ -f "gradlew" ] || [ -f "build.gradle" ]; then
            echo "tool=gradle" >> $GITHUB_OUTPUT
          else
            echo "No Maven/Gradle found in repo root"; exit 1
          fi

      # Maven 빌드 (wrapper 우선, 없으면 mvn)
      - name: Build (Maven)
        if: steps.detect.outputs.tool == 'maven'
        run: |
          if [ -f ./mvnw ]; then ./mvnw -q -DskipTests package; else mvn -B -DskipTests package; fi

      # Gradle 빌드 (wrapper 우선)
      - name: Build (Gradle)
        if: steps.detect.outputs.tool == 'gradle'
        run: |
          chmod +x ./gradlew || true
          ./gradlew clean bootJar -x test || ./gradlew bootJar -x test

      # 산출물 JAR 자동 탐색
      - name: Locate JAR
        id: jar
        run: |
          JAR=$(find . -type f -name "*.jar" -not -name "*sources*" -not -name "*javadoc*" | head -n1)
          echo "jar=$JAR" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR"
          test -n "$JAR" || (echo "JAR not found"; exit 1)

      # 이미지 태그 계산(잡 출력으로 전달)
      - name: Set image names
        id: vars
        run: |
          echo "image_latest=${REGISTRY}/${{ github.repository_owner }}/${IMAGE_REPO}:latest" >> $GITHUB_OUTPUT
          echo "image_sha=${REGISTRY}/${{ github.repository_owner }}/${IMAGE_REPO}:sha-${{ github.sha }}" >> $GITHUB_OUTPUT

      # GHCR 로그인(GITHUB_TOKEN)
      - name: Login GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      # Docker 빌드 & 푸시 (JAR 경로 주입)
      - name: Build & Push image
        run: |
          docker build \
            --build-arg JAR_FILE="${{ steps.jar.outputs.jar }}" \
            -t "${{ steps.vars.outputs.image_latest }}" \
            -t "${{ steps.vars.outputs.image_sha }}" .
          docker push "${{ steps.vars.outputs.image_latest }}"
          docker push "${{ steps.vars.outputs.image_sha }}"

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    env:
      IMAGE_LATEST: ${{ needs.build-and-push.outputs.image_latest }}
    steps:
      - name: Login GHCR (read)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Pull & Up
        run: |
          cd /home/tomcat/secuone
          docker pull "$IMAGE_LATEST"
          docker compose up -d
          docker image prune -f
